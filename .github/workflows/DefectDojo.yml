name: Defect-Dojo-Upload
on:
  workflow_dispatch:  

jobs:
  bulk_upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Download via GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Finds the latest artifact named 'final-security-bundle' in the repo
          gh run download --name final-security-bundle --dir all-reports

      - name: Fetch DefectDojo API Token
        id: get-token
        run: |
          # Dynamically fetch the token using credentials stored in GitHub Secrets
          TOKEN=$(curl -s -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/api-token-auth/" \
            -H "Content-Type: application/json" \
            -d '{"username":"${{ secrets.DD_USERNAME }}","password":"${{ secrets.DD_PASSWORD }}"}' | jq -r .token)
            
          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
            echo "Error: Failed to retrieve API token. Check your URL, credentials, and ensure Codespace port is Public."
            exit 1
          fi
          
          # Securely mask the token in GitHub Actions logs
          echo "::add-mask::$TOKEN"
          # Export it as an environment variable for the upload step
          echo "DD_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Bulk Upload to DefectDojo
        run: |
          # Navigate into the folder where the artifacts were downloaded
          cd all-reports || exit 1

          # 0. Define base variables
          # CHANGED: Switched to import-scan for new data ingestion
          DOJO_URL="${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/"
          AUTH_HEADER="Authorization: Token $DD_TOKEN"
          ENGAGEMENT="Automated-CI-CD"
          PRODUCT_BASE="Robot-Shop-Microservices"
          PRODUCT_TYPE="Robot-Shop-App"

          # 1. Handle SAST
          if [ -f "semgrep-reports.sarif" ]; then
            echo "Uploading Semgrep SAST..."
            # CHANGED: Removed -s to see the API response
            curl -X POST "$DOJO_URL" \
              -H "$AUTH_HEADER" \
              -F "scan_type=SARIF" \
              -F "product_type_name=$PRODUCT_TYPE" \
              -F "product_name=$PRODUCT_BASE-Code" \
              -F "engagement_name=$ENGAGEMENT" \
              -F "auto_create_context=True" \
              -F "file=@semgrep-reports.sarif"
            echo -e "\n"
          fi

          # 2. Handle Secrets
          if [ -f "results.sarif" ]; then
            echo "Uploading Gitleaks Secrets..."
            curl -X POST "$DOJO_URL" \
              -H "$AUTH_HEADER" \
              -F "scan_type=Gitleaks Scan" \
              -F "product_type_name=$PRODUCT_TYPE" \
              -F "product_name=$PRODUCT_BASE-Secrets" \
              -F "engagement_name=$ENGAGEMENT" \
              -F "auto_create_context=True" \
              -F "file=@results.sarif"
            echo -e "\n"
          fi

          # 3. Handle All Image Scans (The Package approach)
          for report in *-reports.sarif; do
            if [ -f "$report" ] && [[ "$report" != "semgrep-reports.sarif" && "$report" != "gitleaks-reports.sarif" ]]; then
              APP_NAME=$(echo "$report" | sed 's/-reports.sarif//')
              echo "Uploading Image Scan for $APP_NAME..."
              curl -X POST "$DOJO_URL" \
                -H "$AUTH_HEADER" \
                -F "scan_type=SARIF" \
                -F "product_type_name=$PRODUCT_TYPE" \
                -F "product_name=$PRODUCT_BASE-Image-$APP_NAME" \
                -F "engagement_name=$ENGAGEMENT" \
                -F "auto_create_context=True" \
                -F "file=@$report"
              echo -e "\n"
            fi
          done

          # 4. Handle DAST (ZAP HTML report)
          if [ -f "report_html.html" ]; then
             echo "Uploading ZAP DAST..."
             curl -X POST "$DOJO_URL" \
              -H "$AUTH_HEADER" \
              -F "scan_type=ZAP Scan" \
              -F "product_type_name=$PRODUCT_TYPE" \
              -F "product_name=$PRODUCT_BASE-Web" \
              -F "engagement_name=$ENGAGEMENT" \
              -F "auto_create_context=True" \
              -F "file=@report_html.html"
             echo -e "\n"
          fi
