name: Defect-Dojo-Upload
on:
  workflow_dispatch:  

jobs:
  bulk_upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
      - name: Download via GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Finds the latest artifact named 'final-security-bundle' in the repo
          gh run download --name final-security-bundle --dir all-reports
      # - name: Download Unified Bundle
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: final-security-bundle 

      - name: Fetch DefectDojo API Token (Debug Mode)
        id: get-token
        run: |
          # 1. Check if the URL secret actually contains data
          echo "Checking URL Secret..."
          echo "Target URL: ${{ secrets.DEFECTDOJO_URL }}/api/v2/api-token-auth/"
          
          # 2. Run curl in VERBOSE mode (-v) to see the network handshake and errors
          # We removed the -s (silent) flag.
          curl -v -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/api-token-auth/" \
            -H "Content-Type: application/json" \
            -d '{"username":"${{ secrets.DD_USERNAME }}","password":"${{ secrets.DD_PASSWORD }}"}'
          
          # 3. Force the pipeline to fail immediately here so we can read the logs
          echo ""
          echo "Stopping pipeline here to review the verbose network output above."
          exit 1
          
      - name: Bulk Upload to DefectDojo
        run: |
          # Navigate into the folder where the artifacts were downloaded
          cd all-reports || exit 1

          # 0. Define base variables for cleaner curl commands
          DOJO_URL="${{ secrets.DEFECTDOJO_URL }}/api/v2/reimport-scan/"
          AUTH_HEADER="Authorization: Token $DD_TOKEN"
          ENGAGEMENT="Automated-CI-CD"
          PRODUCT_BASE="Robot-Shop-Microservices"

          # 1. Handle SAST
          if [ -f "semgrep-reports.sarif" ]; then
            curl -X POST "$DOJO_URL" \
              -H "$AUTH_HEADER" \
              -F "scan_type=SARIF" \
              -F "product_name=$PRODUCT_BASE-Code" \
              -F "engagement_name=$ENGAGEMENT" \
              -F "auto_create_context=True" \
              -F "file=@semgrep-reports.sarif"
          fi

          # 2. Handle Secrets
          if [ -f "results.sarif" ]; then
            curl -X POST "$DOJO_URL" \
              -H "$AUTH_HEADER" \
              -F "scan_type=Gitleaks Scan" \
              -F "product_name=$PRODUCT_BASE-Secrets" \
              -F "engagement_name=$ENGAGEMENT" \
              -F "auto_create_context=True" \
              -F "file=@results.sarif"
          fi

          # 3. Handle All Image Scans
          for report in *-reports.sarif; do
            # Check if the file actually exists to avoid glob errors
            if [ -f "$report" ] && [[ "$report" != "semgrep-reports.sarif" && "$report" != "gitleaks-reports.sarif" ]]; then
              APP_NAME=$(echo $report | sed 's/-reports.sarif//')
              curl -X POST "$DOJO_URL" \
                -H "$AUTH_HEADER" \
                -F "scan_type=SARIF" \
                -F "product_name=$PRODUCT_BASE-Image-$APP_NAME" \
                -F "engagement_name=$ENGAGEMENT" \
                -F "auto_create_context=True" \
                -F "file=@$report"
            fi
          done

          # 4. Handle DAST
          if [ -f "report_html.html" ]; then
             curl -X POST "$DOJO_URL" \
              -H "$AUTH_HEADER" \
              -F "scan_type=ZAP Scan" \
              -F "product_name=$PRODUCT_BASE-Web" \
              -F "engagement_name=$ENGAGEMENT" \
              -F "auto_create_context=True" \
              -F "file=@report_html.html"
          fi
