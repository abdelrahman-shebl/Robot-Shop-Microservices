resource "helm_release" "argocd_apps" {
  name       = "argocd-apps"
  chart      = "./charts/argocd-apps"
  namespace  = "argocd"

  values = [
    # Layer 1: The Base Config (Shared by everyone)
    file("${path.module}/values/common.yaml"),

    # Layer 2: The Environment Config (Static Dev/Prod settings)
    file("${path.module}/values/env-${var.environment}.yaml"),

    # Layer 3: The Dynamic Overrides (Injected from Terraform)
    yamlencode({
      karpenter = {
        roleArn   = module.karpenter.iam_role_arn
        queueName = module.karpenter.queue_name
      }
      opencost = {
        accountID = data.aws_caller_identity.current.account_id
      }
    })
  ]
}